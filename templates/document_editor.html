<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ job_title }} ì±„ìš© ì„œë¥˜ ì—ë””í„°</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>âœ¨ {{ job_title }} ì±„ìš© ì„œë¥˜ ë§ì¶¤ ì—ë””í„° âœ¨</h1>
        <p class="job-description">í˜„ì¬ ì§ë¬´: <strong>{{ job_title }}</strong></p>

        <div id="document-diagram">
            <div class="diagram-node job-node" data-doc-type="job">{{ job_title }}</div>
            <div class="initial-documents">
                <div class="diagram-node document-node" data-doc-type="resume" data-version="0">ì´ë ¥ì„œ</div>
                <div class="diagram-node document-node" data-doc-type="cover_letter" data-version="0">ìê¸°ì†Œê°œì„œ</div>
                <div class="diagram-node document-node" data-doc-type="portfolio" data-version="0">í¬íŠ¸í´ë¦¬ì˜¤</div>
                <div class="diagram-node document-node" data-doc-type="career_statement" data-version="0">ê²½ë ¥ê¸°ìˆ ì„œ</div>
            </div>
        </div>

        <div id="edit-modal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h2 id="modal-title"></h2>
                <div id="loading-overlay" class="loading-overlay" style="display: none;">
                    <div class="spinner"></div>
                    <p style="margin-top: 20px; font-weight: bold;">AIê°€ ë¬¸ì„œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</p>
                </div>
                <form id="document-form">
                    <div id="form-fields"></div>
                    <div id="ai-feedback-area" style="margin-top: 20px; padding: 15px; background-color: #e6f7ff; border: 1px solid #91d5ff; border-radius: 5px; display: none;">
                        <h3>ğŸ’¡ AI í”¼ë“œë°±</h3>
                        <p id="ai-feedback-content"></p>
                    </div>
                    <button type="submit">ì €ì¥ ë° ë¶„ì„</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // JavaScript for diagram drawing, modal control, and API calls
        // ë§¤ìš° ë³µì¡í•˜ë¯€ë¡œ ì£¼ìš” ë¡œì§ë§Œ ì„¤ëª…í•©ë‹ˆë‹¤.

        const jobTitle = "{{ job_title }}";
        const documentDiagram = document.getElementById('document-diagram');
        const editModal = document.getElementById('edit-modal');
        const modalTitle = document.getElementById('modal-title');
        const formFields = document.getElementById('form-fields');
        const aiFeedbackArea = document.getElementById('ai-feedback-area');
        const aiFeedbackContent = document.getElementById('ai-feedback-content');
        const documentForm = document.getElementById('document-form');
        let currentDocType = '';
        let currentDocVersion = 0; // ê° ë¬¸ì„œ íƒ€ì…ë³„ í˜„ì¬ í™œì„± ë²„ì „ (0ì€ ì´ˆê¸° ë²„ì „)
        
        // ê° ë¬¸ì„œ íƒ€ì…ë³„ ë°ì´í„° ë° ë²„ì „ ê´€ë¦¬ë¥¼ ìœ„í•œ ê°ì²´ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì„ì‹œ ì €ì¥)
        const documentData = {
            resume: [{ version: 0, content: {}, displayContent: "ì´ë ¥ì„œ (ì´ˆê¸°)", koreanName: "ì´ë ¥ì„œ" }],
            cover_letter: [{ version: 0, content: {}, displayContent: "ìê¸°ì†Œê°œì„œ (ì´ˆê¸°)", koreanName: "ìê¸°ì†Œê°œì„œ" }],
            portfolio: [{ version: 0, content: {}, displayContent: "í¬íŠ¸í´ë¦¬ì˜¤ (ì´ˆê¸°)", koreanName: "í¬íŠ¸í´ë¦¬ì˜¤" }],
            career_statement: [{ version: 0, content: {}, displayContent: "ê²½ë ¥ê¸°ìˆ ì„œ (ì´ˆê¸°)", koreanName: "ê²½ë ¥ê¸°ìˆ ì„œ" }]
        };

        // ë‹¤ì´ì•„ê·¸ë¨ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ì´ˆê¸° ë¡œë“œ ë° ì—…ë°ì´íŠ¸ ì‹œ í˜¸ì¶œ)
        function drawDiagram() {
            documentDiagram.innerHTML = `<div class="diagram-node job-node" data-doc-type="job">${jobTitle}</div>`;
            const docsContainer = document.createElement('div');
            docsContainer.className = 'initial-documents'; // ê¸°ì¡´ CSS í´ë˜ìŠ¤ ì¬ì‚¬ìš©

            Object.keys(documentData).forEach(docType => {
                const docColumn = document.createElement('div');
                docColumn.className = 'document-column'; // ê° ë¬¸ì„œ íƒ€ì…ì„ ìœ„í•œ ìˆ˜ì§ ì»¨í…Œì´ë„ˆ

                const versions = documentData[docType];
                versions.forEach((versionData, index) => {
                    const isLatest = index === versions.length - 1;
                    // createDocumentNodeì— í•œê¸€ ì´ë¦„(versionData.koreanName)ê³¼ ìµœì‹  ë²„ì „ ì—¬ë¶€ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
                    const docNode = createDocumentNode(docType, versionData.version, versionData.displayContent, versionData.koreanName, isLatest);
                    docColumn.appendChild(docNode);
                });

                docsContainer.appendChild(docColumn);
            });

            documentDiagram.appendChild(docsContainer);
            setupNodeClickEvents();
        }

        // ë¬¸ì„œ ë…¸ë“œ ìƒì„± í•¨ìˆ˜
        function createDocumentNode(type, version, displayText, koreanName, isLatest) {
            const node = document.createElement('div');
            node.className = 'diagram-node document-node';
            node.dataset.docType = type;
            node.dataset.version = version;

            if (koreanName) {
                node.dataset.koreanName = koreanName;
            }

            let content = `<span>${displayText}</span>`;
            // ìµœì‹  ë²„ì „ì´ ì•„ë‹ˆë©´ì„œ, ë²„ì „ 0(ì´ˆê¸°)ì´ ì•„ë‹Œ ë…¸ë“œì—ë§Œ 'ë˜ëŒë¦¬ê¸°' ë²„íŠ¼ ì¶”ê°€
            if (!isLatest) {
                 content += `<button class="rollback-button" data-doc-type="${type}" data-version="${version}">ë˜ëŒë¦¬ê¸°</button>`;
            }
            node.innerHTML = content;
            return node;
        }

        // ë…¸ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì • (ëª¨ë‹¬ ì—´ê¸°)
        function setupNodeClickEvents() {
            // 'ë˜ëŒë¦¬ê¸°' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            document.querySelectorAll('.rollback-button').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                    const typeToRollback = e.target.dataset.docType;
                    const versionToRollback = parseInt(e.target.dataset.version, 10);
                    
                    if (confirm(`${documentData[typeToRollback][0].koreanName} ë¬¸ì„œë¥¼ ë²„ì „ ${versionToRollback}ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ìƒˆ ë²„ì „ì„ ìƒì„±í•©ë‹ˆë‹¤.`)) {
                        const newVersion = documentData[typeToRollback].length;
                        const contentToRestore = documentData[typeToRollback].find(v => v.version === versionToRollback).content;
                        const originalKoreanName = documentData[typeToRollback][0].koreanName;

                        documentData[typeToRollback].push({
                            version: newVersion,
                            content: contentToRestore,
                            displayContent: `${originalKoreanName} (v${newVersion} - ë³µì›ë¨)`,
                            koreanName: originalKoreanName
                        });

                        drawDiagram();
                        alert('ë¬¸ì„œê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                };
            });

            document.querySelectorAll('.diagram-node.document-node').forEach(node => {
                node.onclick = async (e) => {
                    // í´ë¦­ëœ ë…¸ë“œì˜ ë¬¸ì„œ íƒ€ì…, ë²„ì „, í•œê¸€ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                    const clickedNode = e.target.closest('.document-node');
                    currentDocType = clickedNode.dataset.docType;
                    currentDocVersion = parseInt(clickedNode.dataset.version, 10);
                    // ë°ì´í„° ì†ì„±ì— ì €ì¥ëœ í•œê¸€ ì´ë¦„ì„ ì¼ê´€ë˜ê²Œ ì‚¬ìš©
                    const currentDocTitle = clickedNode.dataset.koreanName;

                    // ëª¨ë‹¬ ì œëª© ì„¤ì •
                    modalTitle.textContent = `${currentDocTitle} í¸ì§‘`;

                    // í•´ë‹¹ ë¬¸ì„œ íƒ€ì…ê³¼ ë²„ì „ì— ë§ëŠ” ë‚´ìš© ë¡œë“œ
                    const docContent = documentData[currentDocType].find(d => d.version === currentDocVersion).content;
                    
                    // ì§ë¬´ë³„ ë¬¸ì„œ ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸° (ë°±ì—”ë“œ API í˜¸ì¶œ)
                    const formSchema = await fetch(`/api/job_schema/${currentDocType}?job_slug=${jobTitle}`).then(res => res.json());
                    renderFormFields(formSchema.fields, docContent);
                    
                    aiFeedbackArea.style.display = 'none'; // í”¼ë“œë°± ì˜ì—­ ìˆ¨ê¹€
                    editModal.style.display = 'block';
                };
            });

            // ë¡¤ë°± ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
            document.querySelectorAll('.rollback-button').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation(); // ë…¸ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
                    const typeToRollback = button.dataset.docType;
                    const versionToRollback = parseInt(button.dataset.version);

                    const targetData = documentData[typeToRollback].find(d => d.version === versionToRollback);
                    if (targetData) {
                        alert(`${targetData.koreanName}ì„(ë¥¼) ë²„ì „ ${versionToRollback}ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.`);
                        
                        currentDocType = typeToRollback;
                        currentDocVersion = versionToRollback;
                        
                        // í•œê¸€ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë‹¬ ì œëª© ì„¤ì •
                        const docTitle = documentData[typeToRollback][0].koreanName;
                        modalTitle.textContent = `${docTitle} (ë²„ì „ ${versionToRollback}) ë‚´ìš© í¸ì§‘`;
                        const docContent = documentData[typeToRollback].find(d => d.version === versionToRollback).content;
                        
                        fetch(`/api/job_schema/${currentDocType}?job_slug=${jobTitle}`)
                            .then(res => res.json())
                            .then(formSchema => renderFormFields(formSchema.fields, docContent));
                        
                        aiFeedbackArea.style.display = 'none';
                        editModal.style.display = 'block';
                    }
                };
            });
        }

        // í¼ í•„ë“œ ë Œë”ë§ í•¨ìˆ˜
        function renderFormFields(fields, currentContent) {
            // í˜„ì¬ ë¬¸ì„œì˜ í•œê¸€ ì œëª© ê°€ì ¸ì˜¤ê¸°
            const currentDocTitle = document.querySelector(`.document-node[data-doc-type='${currentDocType}']`).dataset.koreanName;

            formFields.innerHTML = '';
            fields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'input-group';
                if (field.type === 'textarea') {
                    div.innerHTML = `
                        <label>${field.label}:</label>
                        <textarea name="${field.name}" placeholder="${field.placeholder || ''}">${currentContent[field.name] || ''}</textarea>
                    `;
                } else if (field.type === 'text') {
                    div.innerHTML = `
                        <label>${field.label}:</label>
                        <input type="text" name="${field.name}" value="${currentContent[field.name] || ''}" placeholder="${field.placeholder || ''}">
                    `;
                } else if (field.type === 'custom_qa') { // ìê¸°ì†Œê°œì„œì˜ ì§ˆë¬¸/ë‹µë³€ í•„ë“œ
                    // ë¼ë²¨ì„ ë™ì ìœ¼ë¡œ ë³€ê²½
                    field.label = `${currentDocTitle} ì§ˆë¬¸ê³¼ ë‹µë³€`;
                    div.innerHTML = `
                        <label>${field.label}:</label>
                        <div id="qa-container"></div>
                        <button type="button" id="add-qa">ì§ˆë¬¸/ë‹µë³€ ì¶”ê°€</button>
                    `;
                    const qaContainer = div.querySelector('#qa-container');
                    const addQaButton = div.querySelector('#add-qa');
                    
                    // ê¸°ì¡´ Q&A ë¡œë“œ
                    const qaPairs = currentContent[field.name] || [];
                    qaPairs.forEach(qa => addQaField(qaContainer, qa.question, qa.answer));
                    
                    addQaButton.onclick = () => addQaField(qaContainer);
                }
                formFields.appendChild(div);
            });
        }

        function addQaField(container, question = '', answer = '') {
            const qaDiv = document.createElement('div');
            qaDiv.className = 'qa-pair';
            qaDiv.style.marginBottom = '10px';
            qaDiv.innerHTML = `
                <input type="text" class="qa-question" placeholder="ì§ˆë¬¸ ì…ë ¥" value="${question}" style="width: calc(100% - 100px); margin-right: 5px;">
                <textarea class="qa-answer" placeholder="ë‹µë³€ ì…ë ¥" style="width: 100%; min-height: 80px;">${answer}</textarea>
                <button type="button" class="remove-qa" style="background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">ì‚­ì œ</button>
            `;
            container.appendChild(qaDiv);
            qaDiv.querySelector('.remove-qa').onclick = () => qaDiv.remove();
        }

        // í¼ ì œì¶œ (ì €ì¥ ë° AI ë¶„ì„ ìš”ì²­)
        documentForm.onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(documentForm);
            const docContent = {};
            // ìê¸°ì†Œê°œì„œ Q&A ì²˜ë¦¬
            if (currentDocType === 'cover_letter') {
                const qaPairs = [];
                document.querySelectorAll('.qa-pair').forEach(qaDiv => {
                    const question = qaDiv.querySelector('.qa-question').value;
                    const answer = qaDiv.querySelector('.qa-answer').value;
                    if (question && answer) {
                        qaPairs.push({ question, answer });
                    }
                });
                docContent['qa'] = qaPairs; // 'qa' í•„ë“œì— ë°°ì—´ ì €ì¥
            }
            // ì¼ë°˜ í•„ë“œ ì²˜ë¦¬
            for (let [key, value] of formData.entries()) {
                if (key !== 'qa') { // qa í•„ë“œëŠ” ìœ„ì—ì„œ ì´ë¯¸ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ì œì™¸
                     docContent[key] = value;
                }
            }

            // ë‚´ìš© ìœ íš¨ì„± ê²€ì‚¬
            let isEmpty = false;
            if (currentDocType === 'cover_letter') {
                // 'qa' ë°°ì—´ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
                if (!docContent.qa || docContent.qa.length === 0) {
                    isEmpty = true;
                }
            } else if (currentDocType === 'resume') {
                // ëª¨ë“  í•„ë“œê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
                if (Object.keys(docContent).length === 0 || Object.values(docContent).every(v => typeof v === 'string' && v.trim() === '')) {
                    isEmpty = true;
                }
            }

            if (isEmpty) {
                alert('ë¶„ì„í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return; // ë¶„ì„ ì¤‘ë‹¨
            }

            // AI ë¶„ì„ ìš”ì²­
            try {
                // ë°±ì—”ë“œ APIë¡œ ë¬¸ì„œ ë‚´ìš©ê³¼ íƒ€ì… ì „ì†¡ (FormData ì‚¬ìš©)
                const analysisFormData = new FormData();
                analysisFormData.append('job_title', jobTitle);
                analysisFormData.append('document_content', JSON.stringify(docContent)); // ê°ì²´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
                analysisFormData.append('current_version', currentDocVersion);

                const loadingOverlay = document.getElementById('loading-overlay');
                const formElements = document.getElementById('form-fields');

                loadingOverlay.style.display = 'flex';
                formElements.style.display = 'none'; // Hide form fields

                const response = await fetch(`/api/analyze_document/${currentDocType}`, {
                    method: 'POST',
                    // FormDataë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” Content-Type í—¤ë”ë¥¼ ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ì„¤ì •í•˜ë„ë¡ ë‘¡ë‹ˆë‹¤.
                    body: analysisFormData
                });
                const result = await response.json();

                loadingOverlay.style.display = 'none';
                formElements.style.display = 'block'; // Show form fields

                if (response.ok) {
                    aiFeedbackContent.textContent = result.feedback;
                    aiFeedbackArea.style.display = 'block';

                    // ìƒˆë¡œìš´ ë²„ì „ìœ¼ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ë‹¤ì´ì–´ê·¸ë¨ í™•ì¥
                    const newVersion = documentData[currentDocType].length; // í˜„ì¬ ë²„ì „ ë‹¤ìŒ ë²ˆí˜¸
                    const originalKoreanName = documentData[currentDocType][0].koreanName; // ì›ë³¸ í•œê¸€ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
                    documentData[currentDocType].push({
                        version: newVersion,
                        content: docContent, // ì €ì¥ëœ ë‚´ìš©
                        displayContent: `${originalKoreanName} (v${newVersion})`, // í•œê¸€ ì´ë¦„ ìœ ì§€
                        koreanName: originalKoreanName
                    });
                    currentDocVersion = newVersion; // í˜„ì¬ í™œì„± ë²„ì „ ì—…ë°ì´íŠ¸
                    drawDiagram(); // ë‹¤ì´ì–´ê·¸ë¨ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    alert('ë¬¸ì„œê°€ ì €ì¥ë˜ê³  ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤. AI í”¼ë“œë°±ì„ í™•ì¸í•˜ì„¸ìš”.');
                    // editModal.style.display = 'none'; // ëª¨ë‹¬ ë‹«ê¸°
                } else {
                    alert(`ë¶„ì„ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('API í†µì‹  ì˜¤ë¥˜:', error);
                alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                const loadingOverlay = document.getElementById('loading-overlay');
                const formElements = document.getElementById('form-fields');

                loadingOverlay.style.display = 'none';
                formElements.style.display = 'block'; // Show form fields
            }
        };

        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        document.querySelector('.close-button').onclick = () => {
            editModal.style.display = 'none';
        };
        // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = (event) => {
            if (event.target == editModal) {
                editModal.style.display = 'none';
            }
        };

        // ì´ˆê¸° ë‹¤ì´ì•„ê·¸ë¨ ê·¸ë¦¬ê¸°
        drawDiagram();
    </script>
</body>
</html>