<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ job_title }} ì±„ìš© ì„œë¥˜ ì—ë””í„°</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="container">
      <h1>âœ¨ {{ job_title }} ì±„ìš© ì„œë¥˜ ë§ì¶¤ ì—ë””í„° âœ¨</h1>
      <p class="job-description">í˜„ì¬ ì§ë¬´: <strong>{{ job_title }}</strong></p>

      <div id="document-diagram">
        <div class="diagram-node job-node" data-doc-type="job">
          {{ job_title }}
        </div>
        <div class="initial-documents">
          <div
            class="diagram-node document-node"
            data-doc-type="resume"
            data-version="0"
          >
            ì´ë ¥ì„œ
          </div>
          <div
            class="diagram-node document-node"
            data-doc-type="cover_letter"
            data-version="0"
          >
            ìê¸°ì†Œê°œì„œ
          </div>
          <div
            class="diagram-node document-node"
            data-doc-type="portfolio"
            data-version="0"
          >
            í¬íŠ¸í´ë¦¬ì˜¤
          </div>
        </div>
      </div>

      <div id="edit-modal" class="modal">
        <div class="modal-content">
          <span class="close-button">&times;</span>
          <h2 id="modal-title"></h2>
          <div
            id="loading-overlay"
            class="loading-overlay"
            style="display: none"
          >
            <div class="spinner"></div>
            <p style="margin-top: 20px; font-weight: bold">
              AIê°€ ë¬¸ì„œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...
            </p>
          </div>
          <form id="document-form">
            <div id="form-fields"></div>
            <div
              id="ai-feedback-area"
              style="
                margin-top: 20px;
                padding: 15px;
                background-color: #e6f7ff;
                border: 1px solid #91d5ff;
                border-radius: 5px;
                display: none;
              "
            >
              <h3>ğŸ’¡ AI í”¼ë“œë°±</h3>
              <p id="ai-feedback-content"></p>
            </div>
            <button type="submit">ì €ì¥ ë° ë¶„ì„</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // JavaScript for diagram drawing, modal control, and API calls
      // ë§¤ìš° ë³µì¡í•˜ë¯€ë¡œ ì£¼ìš” ë¡œì§ë§Œ ì„¤ëª…í•©ë‹ˆë‹¤.

      const jobTitle = "{{ job_title }}";
      const documentDiagram = document.getElementById("document-diagram");
      const editModal = document.getElementById("edit-modal");
      const modalTitle = document.getElementById("modal-title");
      const formFields = document.getElementById("form-fields");
      const aiFeedbackArea = document.getElementById("ai-feedback-area");
      const aiFeedbackContent = document.getElementById("ai-feedback-content");
      const documentForm = document.getElementById("document-form");
      let currentDocType = "";
      let currentDocVersion = 0; // ê° ë¬¸ì„œ íƒ€ì…ë³„ í˜„ì¬ í™œì„± ë²„ì „ (0ì€ ì´ˆê¸° ë²„ì „)

      // ê° ë¬¸ì„œ íƒ€ì…ë³„ ë°ì´í„° ë° ë²„ì „ ê´€ë¦¬ë¥¼ ìœ„í•œ ê°ì²´ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì„ì‹œ ì €ì¥)
      const documentData = {
        resume: [
          {
            version: 0,
            content: {},
            displayContent: "ì´ë ¥ì„œ (ì´ˆê¸°)",
            koreanName: "ì´ë ¥ì„œ",
            feedback: null,
          },
        ],
        cover_letter: [
          {
            version: 0,
            content: {},
            displayContent: "ìê¸°ì†Œê°œì„œ (ì´ˆê¸°)",
            koreanName: "ìê¸°ì†Œê°œì„œ",
            feedback: null,
          },
        ],
        portfolio: [
          {
            version: 0,
            content: {},
            displayContent: "í¬íŠ¸í´ë¦¬ì˜¤ (ì´ˆê¸°)",
            koreanName: "í¬íŠ¸í´ë¦¬ì˜¤",
            feedback: null,
          },
        ],
      };

      // ë‹¤ì´ì•„ê·¸ë¨ ê·¸ë¦¬ê¸° í•¨ìˆ˜ (ì´ˆê¸° ë¡œë“œ ë° ì—…ë°ì´íŠ¸ ì‹œ í˜¸ì¶œ)
      function drawDiagram() {
        documentDiagram.innerHTML = `<div class="diagram-node job-node" data-doc-type="job">${jobTitle}</div>`;
        const docsContainer = document.createElement("div");
        docsContainer.className = "initial-documents"; // ê¸°ì¡´ CSS í´ë˜ìŠ¤ ì¬ì‚¬ìš©

        Object.keys(documentData).forEach((docType) => {
          const docColumn = document.createElement("div");
          docColumn.className = "document-column"; // ê° ë¬¸ì„œ íƒ€ì…ì„ ìœ„í•œ ìˆ˜ì§ ì»¨í…Œì´ë„ˆ

          const versions = documentData[docType];
          versions.forEach((versionData, index) => {
            const isLatest = index === versions.length - 1;
            // createDocumentNodeì— í•œê¸€ ì´ë¦„(versionData.koreanName)ê³¼ ìµœì‹  ë²„ì „ ì—¬ë¶€ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
            const docNode = createDocumentNode(
              docType,
              versionData.version,
              versionData.displayContent,
              versionData.koreanName,
              isLatest
            );
            docColumn.appendChild(docNode);
          });

          docsContainer.appendChild(docColumn);
        });

        documentDiagram.appendChild(docsContainer);
        setupNodeClickEvents();
      }

      // ë¬¸ì„œ ë…¸ë“œ ìƒì„± í•¨ìˆ˜
      function createDocumentNode(
        type,
        version,
        displayText,
        koreanName,
        isLatest
      ) {
        const node = document.createElement("div");
        node.className = "diagram-node document-node";
        node.dataset.docType = type;
        node.dataset.version = version;

        if (koreanName) {
          node.dataset.koreanName = koreanName;
        }

        let content = `<span>${displayText}</span>`;
        // ìµœì‹  ë²„ì „ì´ ì•„ë‹ˆë©´ì„œ, ë²„ì „ 0(ì´ˆê¸°)ì´ ì•„ë‹Œ ë…¸ë“œì—ë§Œ 'ë˜ëŒë¦¬ê¸°' ë²„íŠ¼ ì¶”ê°€
        if (!isLatest) {
          content += `<button class="rollback-button" data-doc-type="${type}" data-version="${version}">ë˜ëŒë¦¬ê¸°</button>`;
        }
        node.innerHTML = content;
        return node;
      }

      // ë…¸ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì„¤ì • (ëª¨ë‹¬ ì—´ê¸°)
      function setupNodeClickEvents() {
        // 'ë˜ëŒë¦¬ê¸°' ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.querySelectorAll(".rollback-button").forEach((button) => {
          button.onclick = (e) => {
            e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            const typeToRollback = e.target.dataset.docType;
            const versionToRollback = parseInt(e.target.dataset.version, 10);

            if (
              confirm(
                `${documentData[typeToRollback][0].koreanName} ë¬¸ì„œë¥¼ ë²„ì „ ${versionToRollback}ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ìƒˆ ë²„ì „ì„ ìƒì„±í•©ë‹ˆë‹¤.`
              )
            ) {
              const newVersion = documentData[typeToRollback].length;
              const contentToRestore = documentData[typeToRollback].find(
                (v) => v.version === versionToRollback
              ).content;
              const originalKoreanName =
                documentData[typeToRollback][0].koreanName;

              documentData[typeToRollback].push({
                version: newVersion,
                content: contentToRestore,
                displayContent: `${originalKoreanName} (v${newVersion} - ë³µì›ë¨)`,
                koreanName: originalKoreanName,
              });

              drawDiagram();
              alert("ë¬¸ì„œê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
          };
        });

        document
          .querySelectorAll(".diagram-node.document-node")
          .forEach((node) => {
            node.onclick = async (e) => {
              // í´ë¦­ëœ ë…¸ë“œì˜ ë¬¸ì„œ íƒ€ì…, ë²„ì „, í•œê¸€ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
              const clickedNode = e.target.closest(".document-node");
              currentDocType = clickedNode.dataset.docType;
              currentDocVersion = parseInt(clickedNode.dataset.version, 10);
              // ë°ì´í„° ì†ì„±ì— ì €ì¥ëœ í•œê¸€ ì´ë¦„ì„ ì¼ê´€ë˜ê²Œ ì‚¬ìš©
              const currentDocTitle = clickedNode.dataset.koreanName;

              // ëª¨ë‹¬ ì œëª© ì„¤ì • (ë²„ì „ ì •ë³´ í¬í•¨)
              modalTitle.textContent = `${currentDocTitle} í¸ì§‘ (v${currentDocVersion})`;

              // í•´ë‹¹ ë¬¸ì„œ íƒ€ì…ê³¼ ë²„ì „ì— ë§ëŠ” ë‚´ìš©ê³¼ í”¼ë“œë°± ë¡œë“œ
              const versionData = documentData[currentDocType].find(
                (d) => d.version === currentDocVersion
              );
              const docContent = versionData.content;
              const savedFeedback = versionData.feedback;

              // ì§ë¬´ë³„ ë¬¸ì„œ ì–‘ì‹ ë¶ˆëŸ¬ì˜¤ê¸° (ë°±ì—”ë“œ API í˜¸ì¶œ)
              const formSchema = await fetch(
                `/api/job_schema/${currentDocType}?job_slug=${jobTitle
                  .replace(/ /g, "-")
                  .toLowerCase()}`
              ).then((res) => res.json());
              renderFormFields(formSchema.fields, docContent);

              // ì €ì¥ëœ í”¼ë“œë°±ì´ ìˆìœ¼ë©´ ë³´ì—¬ì£¼ê³ , ì—†ìœ¼ë©´ ìˆ¨ê¹€
              if (savedFeedback) {
                aiFeedbackContent.textContent = savedFeedback;
                aiFeedbackArea.style.display = "block";
              } else {
                aiFeedbackArea.style.display = "none";
              }

              editModal.style.display = "block";
            };
          });

        // ë¡¤ë°± ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
        document.querySelectorAll(".rollback-button").forEach((button) => {
          button.onclick = (e) => {
            e.stopPropagation(); // ë…¸ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
            const typeToRollback = button.dataset.docType;
            const versionToRollback = parseInt(button.dataset.version);

            const targetData = documentData[typeToRollback].find(
              (d) => d.version === versionToRollback
            );
            if (targetData) {
              alert(
                `${targetData.koreanName}ì„(ë¥¼) ë²„ì „ ${versionToRollback}ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.`
              );

              currentDocType = typeToRollback;
              currentDocVersion = versionToRollback;

              // í•œê¸€ ì´ë¦„ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë‹¬ ì œëª© ì„¤ì •
              const docTitle = documentData[typeToRollback][0].koreanName;
              modalTitle.textContent = `${docTitle} (ë²„ì „ ${versionToRollback}) ë‚´ìš© í¸ì§‘`;
              const docContent = documentData[typeToRollback].find(
                (d) => d.version === versionToRollback
              ).content;

              fetch(`/api/job_schema/${currentDocType}?job_slug=${jobTitle}`)
                .then((res) => res.json())
                .then((formSchema) =>
                  renderFormFields(formSchema.fields, docContent)
                );

              aiFeedbackArea.style.display = "none";
              editModal.style.display = "block";
            }
          };
        });
      }

      // í¼ í•„ë“œ ë Œë”ë§ í•¨ìˆ˜
      function renderFormFields(fields, currentContent) {
        const currentDocTitle = document.querySelector(
          `.document-node[data-doc-type='${currentDocType}']`
        ).dataset.koreanName;
        formFields.innerHTML = "";
        if (currentDocType === "portfolio") {
          // í¬íŠ¸í´ë¦¬ì˜¤ ìš”ì•½ ì „ìš© UI
          formFields.innerHTML = `
                    <div class="input-group">
                        <label>í¬íŠ¸í´ë¦¬ì˜¤ PDF ì—…ë¡œë“œ:</label>
                        <input type="file" name="portfolio_pdf" accept=".pdf">
                    </div>
                    <div class="input-group">
                        <label>í¬íŠ¸í´ë¦¬ì˜¤ ë§í¬ ì…ë ¥:</label>
                        <input type="text" name="portfolio_link" placeholder="í¬íŠ¸í´ë¦¬ì˜¤ê°€ ì—…ë¡œë“œëœ ì›¹ì‚¬ì´íŠ¸, ë¸”ë¡œê·¸, Github ë“± ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
                    </div>
                `;
          // 'ìš”ì•½ ë° ë‹¤ìš´' ë²„íŠ¼ì„ ëª¨ë‹¬ í•˜ë‹¨ì— í‘œì‹œ
          const submitBtn = document.querySelector(
            '#document-form button[type="submit"]'
          );
          submitBtn.textContent = "ìš”ì•½ ë° ë‹¤ìš´";
          // ê¸°ì¡´ submit ì´ë²¤íŠ¸ ì œê±° í›„ ìƒˆë¡œ ë“±ë¡
          documentForm.onsubmit = async (e) => {
            e.preventDefault();
            const pdfInput = document.querySelector(
              'input[name="portfolio_pdf"]'
            );
            const linkInput = document.querySelector(
              'input[name="portfolio_link"]'
            );
            const formData = new FormData();
            formData.append("job_title", jobTitle);
            if (pdfInput.files.length > 0) {
              formData.append("portfolio_pdf", pdfInput.files[0]);
            }
            if (linkInput.value.trim()) {
              formData.append("portfolio_link", linkInput.value.trim());
            }
            if (
              formData.has("portfolio_pdf") ||
              formData.get("portfolio_link")
            ) {
              const loadingOverlay = document.getElementById("loading-overlay");
              loadingOverlay.style.display = "flex";
              try {
                const response = await fetch("/api/portfolio_summary", {
                  method: "POST",
                  body: formData,
                });
                loadingOverlay.style.display = "none";
                if (response.ok) {
                  const blob = await response.blob();
                  const url = window.URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = "portfolio_summary.pdf";
                  document.body.appendChild(a);
                  a.click();
                  a.remove();
                  window.URL.revokeObjectURL(url);
                  alert("ìš”ì•½ PDFê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                  const result = await response.json();
                  alert(result.error || "ìš”ì•½ ì‹¤íŒ¨");
                }
              } catch (err) {
                loadingOverlay.style.display = "none";
                alert("ì„œë²„ ì˜¤ë¥˜: " + err);
              }
            } else {
              alert("PDF íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
            }
          };
          return;
        }
        // --- ìê¸°ì†Œê°œì„œ ê³ ì • ì§ˆë¬¸ ë° ê¸€ììˆ˜ ì¹´ìš´í„° ì¶”ê°€ ì‹œì‘ ---
        else if (currentDocType === "cover_letter") {
          const qaContainer = document.createElement("div");
          qaContainer.id = "qa-container";
          qaContainer.innerHTML = `
                    <div class="input-group">
                        <label>1. í•´ë‹¹ ì§ë¬´ì˜ ì§€ì›ë™ê¸°ì™€ ì „ë¬¸ì„±ì„ ê¸°ë¥´ê¸° ìœ„í•´ ë…¸ë ¥í•œ ê²½í—˜ì„ ì„œìˆ í•˜ì‹œì˜¤.</label>
                        <textarea name="motivation_expertise" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." style="width: 100%; min-height: 120px;">${
                          currentContent.motivation_expertise || ""
                        }</textarea>
                        <div class="char-counter" style="text-align: right; font-size: 0.9em; color: #666; margin-top: 3px;">
                            ê¸€ììˆ˜: <span class="char-count">${
                              (currentContent.motivation_expertise || "").length
                            }</span>
                        </div>
                    </div>
                    <div class="input-group" style="margin-top: 20px;">
                        <label>2. ê³µë™ì˜ ëª©í‘œë¥¼ ìœ„í•´ í˜‘ì—…ì„ í•œ ê²½í—˜ì„ ì„œìˆ í•˜ì‹œì˜¤.</label>
                        <textarea name="collaboration_experience" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." style="width: 100%; min-height: 120px;">${
                          currentContent.collaboration_experience || ""
                        }</textarea>
                        <div class="char-counter" style="text-align: right; font-size: 0.9em; color: #666; margin-top: 3px;">
                            ê¸€ììˆ˜: <span class="char-count">${
                              (currentContent.collaboration_experience || "")
                                .length
                            }</span>
                        </div>
                    </div>
                `;
          formFields.appendChild(qaContainer);

          // ê° textareaì— ê¸€ì ìˆ˜ ì¹´ìš´í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          qaContainer.querySelectorAll("textarea").forEach((textarea) => {
            const charCountSpan =
              textarea.nextElementSibling.querySelector(".char-count");
            textarea.addEventListener("input", () => {
              charCountSpan.textContent = textarea.value.length;
            });
          });
          // ìê¸°ì†Œê°œì„œëŠ” "ì €ì¥ ë° ë¶„ì„" ë²„íŠ¼ ê¸°ëŠ¥ì„ ìœ ì§€í•©ë‹ˆë‹¤.
          const submitBtn = document.querySelector(
            '#document-form button[type="submit"]'
          );
          submitBtn.textContent = "ì €ì¥ ë° ë¶„ì„";
          // ê¸°ì¡´ submit ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ë‹¤ì‹œ ì—°ê²°ë˜ë„ë¡ í•¨ (renderFormFields ë°–ì—ì„œ ì²˜ë¦¬)
          documentForm.onsubmit = handleDocumentFormSubmit; // ì•„ë˜ì— ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
          return;
        }
        // --- ìê¸°ì†Œê°œì„œ ê³ ì • ì§ˆë¬¸ ë° ê¸€ììˆ˜ ì¹´ìš´í„° ì¶”ê°€ ë ---
        fields.forEach((field) => {
          const div = document.createElement("div");
          div.className = "input-group";
          if (field.type === "textarea") {
            div.innerHTML = `
                        <label>${field.label}:</label>
                        <textarea name="${field.name}" placeholder="${
              field.placeholder || ""
            }">${currentContent[field.name] || ""}</textarea>
                    `;
          } else if (field.type === "text") {
            div.innerHTML = `
                        <label>${field.label}:</label>
                        <input type="text" name="${field.name}" value="${
              currentContent[field.name] || ""
            }" placeholder="${field.placeholder || ""}">
                    `;
          } else if (field.type === "custom_qa") {
            // ìê¸°ì†Œê°œì„œì˜ ì§ˆë¬¸/ë‹µë³€ í•„ë“œ (ì´ì œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ)
            // ì´ ë¶€ë¶„ì€ ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
          }
          formFields.appendChild(div);
        });
        // ìê¸°ì†Œê°œì„œê°€ ì•„ë‹Œ ë‹¤ë¥¸ ë¬¸ì„œ íƒ€ì…ì€ "ì €ì¥ ë° ë¶„ì„" ë²„íŠ¼ ê¸°ëŠ¥ì„ ìœ ì§€í•©ë‹ˆë‹¤.
        const submitBtn = document.querySelector(
          '#document-form button[type="submit"]'
        );
        submitBtn.textContent = "ì €ì¥ ë° ë¶„ì„";
        documentForm.onsubmit = handleDocumentFormSubmit; // ì•„ë˜ì— ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
      }

      // ìê¸°ì†Œê°œì„œ ê¸€ììˆ˜ ì¹´ìš´í„° ê¸°ëŠ¥ì„ ìœ„í•œ ë„ìš°ë¯¸ í•¨ìˆ˜ (ì´ì œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ)
      // function addQaField(container, question = '', answer = '') { ... }

      // í¼ ì œì¶œ (ì €ì¥ ë° AI ë¶„ì„ ìš”ì²­) ë¡œì§ì„ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
      const handleDocumentFormSubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(documentForm);
        const docContent = {};

        // ìê¸°ì†Œê°œì„œ ê³ ì • ì§ˆë¬¸ ì²˜ë¦¬
        if (currentDocType === "cover_letter") {
          docContent["motivation_expertise"] =
            formData.get("motivation_expertise") || "";
          docContent["collaboration_experience"] =
            formData.get("collaboration_experience") || "";
        }
        // ì¼ë°˜ í•„ë“œ ì²˜ë¦¬ (ìê¸°ì†Œê°œì„œê°€ ì•„ë‹Œ ê²½ìš°)
        else {
          for (let [key, value] of formData.entries()) {
            docContent[key] = value;
          }
        }

        // ë‚´ìš© ìœ íš¨ì„± ê²€ì‚¬ (ìê¸°ì†Œê°œì„œ ê³ ì • ì§ˆë¬¸ì— ë§ê²Œ ìˆ˜ì •)
        let isEmpty = false;
        if (currentDocType === "cover_letter") {
          if (
            !docContent["motivation_expertise"].trim() &&
            !docContent["collaboration_experience"].trim()
          ) {
            isEmpty = true;
          }
        } else {
          // resume, career_statement ë“± ê¸°ì¡´ ë¬¸ì„œ íƒ€ì…
          if (
            Object.keys(docContent).length === 0 ||
            Object.values(docContent).every(
              (v) => typeof v === "string" && v.trim() === ""
            )
          ) {
            isEmpty = true;
          }
        }

        if (isEmpty) {
          alert("ë¶„ì„í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤. ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return; // ë¶„ì„ ì¤‘ë‹¨
        }

        // AI ë¶„ì„ ìš”ì²­
        try {
          // ë°±ì—”ë“œ APIë¡œ ë¬¸ì„œ ë‚´ìš©ê³¼ íƒ€ì… ì „ì†¡ (FormData ì‚¬ìš©)
          const analysisFormData = new FormData();
          analysisFormData.append("job_title", jobTitle);
          analysisFormData.append(
            "document_content",
            JSON.stringify(docContent)
          ); // ê°ì²´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
          analysisFormData.append("current_version", currentDocVersion);

          const loadingOverlay = document.getElementById("loading-overlay");
          const formElements = document.getElementById("form-fields");

          loadingOverlay.style.display = "flex";
          formElements.style.display = "none"; // Hide form fields

          const response = await fetch(
            `/api/analyze_document/${currentDocType}`,
            {
              method: "POST",
              // FormDataë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” Content-Type í—¤ë”ë¥¼ ë¸Œë¼ìš°ì €ê°€ ìë™ìœ¼ë¡œ ì„¤ì •í•˜ë„ë¡ ë‘¡ë‹ˆë‹¤.
              body: analysisFormData,
            }
          );
          const result = await response.json();

          loadingOverlay.style.display = "none";
          formElements.style.display = "block"; // Show form fields

          if (response.ok) {
            aiFeedbackContent.textContent = result.feedback;
            aiFeedbackArea.style.display = "block";

            // 1. Update the content of the currently edited version.
            const versionToUpdate = documentData[currentDocType].find(
              (d) => d.version === currentDocVersion
            );
            if (versionToUpdate) {
              versionToUpdate.content = docContent;
            }

            // 2. Create a new version with the updated content.
            const newVersion = documentData[currentDocType].length;
            const originalKoreanName =
              documentData[currentDocType][0].koreanName;
            documentData[currentDocType].push({
              version: newVersion,
              content: docContent,
              displayContent: `${originalKoreanName} (v${newVersion})`,
              koreanName: originalKoreanName,
              feedback: result.feedback, // Store the feedback with the new version
            });
            currentDocVersion = newVersion;
            drawDiagram();
            alert("ë¬¸ì„œê°€ ì €ì¥ë˜ê³  ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤. AI í”¼ë“œë°±ì„ í™•ì¸í•˜ì„¸ìš”.");
          } else {
            alert(`ë¶„ì„ ì‹¤íŒ¨: ${result.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`);
          }
        } catch (error) {
          console.error("API í†µì‹  ì˜¤ë¥˜:", error);
          alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          const loadingOverlay = document.getElementById("loading-overlay");
          const formElements = document.getElementById("form-fields");

          loadingOverlay.style.display = "none";
          formElements.style.display = "block"; // Show form fields
        }
      };

      // ì´ˆê¸° í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      documentForm.onsubmit = handleDocumentFormSubmit;

      // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
      document.querySelector(".close-button").onclick = () => {
        editModal.style.display = "none";
      };
      // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
      window.onclick = (event) => {
        if (event.target == editModal) {
          editModal.style.display = "none";
        }
      };

      // ì´ˆê¸° ë‹¤ì´ì•„ê·¸ë¨ ê·¸ë¦¬ê¸°
      drawDiagram();
    </script>
  </body>
</html>
