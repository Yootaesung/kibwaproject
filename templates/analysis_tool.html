<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ job_title }} í•©ê²© ê°€ëŠ¥ì„± ë¶„ì„</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; color: #343a40; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 90%;
            max-width: 1000px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        h1 { color: #0056b3; text-align: center; margin-bottom: 30px; font-size: 2.5em; }
        .section-title { font-size: 1.4em; color: #495057; margin-bottom: 15px; border-bottom: 2px solid #e9ecef; padding-bottom: 8px; }

        /* Form Styles */
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #343a40; }
        .input-group textarea, .input-group input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            resize: vertical;
            min-height: 120px;
        }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
        .checkbox-group div { display: flex; align-items: center; background-color: #e9ecef; padding: 10px 15px; border-radius: 8px; transition: background-color 0.2s; }
        .checkbox-group div:hover { background-color: #dee2e6; }
        .checkbox-group input[type="checkbox"] { margin-right: 8px; transform: scale(1.2); }

        .submit-button {
            background-color: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.3em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
        }
        .submit-button:hover { background-color: #218838; transform: translateY(-3px); }
        .submit-button:active { transform: translateY(0); }
        .loading { display: none; text-align: center; margin-top: 20px; color: #6c757d; }

        /* Result Section */
        .result-section {
            margin-top: 40px;
            border-top: 2px dashed #007bff;
            padding-top: 30px;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
        }
        .result-section h2 { color: #007bff; font-size: 1.8em; text-align: center; margin-bottom: 25px; }
        .fishbone-diagram {
            position: relative;
            width: 100%;
            height: 300px; /* ê³ ì • ë†’ì´ */
            background-color: #f0f0f0; /* ë°°ê²½ìƒ‰ */
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            overflow: hidden; /* ê¼¬ë¦¬ê°€ íŠ€ì–´ë‚˜ê°€ì§€ ì•Šë„ë¡ */
        }
        .fishbone-diagram img {
            max-height: 100%; /* ì´ë¯¸ì§€ ë†’ì´ë¥¼ ë‹¤ì´ì–´ê·¸ë¨ ë†’ì´ì— ë§ì¶¤ */
            width: auto;
            object-fit: contain;
            transition: all 0.5s ease-in-out; /* ê¼¬ë¦¬ ë³€í™” ì• ë‹ˆë©”ì´ì…˜ */
        }
        .fishbone-head {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.8em;
            font-weight: bold;
            color: #d9534f;
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
        .fishbone-prob {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2.5em;
            font-weight: bold;
            color: #007bff;
            animation: bounceIn 1s forwards;
        }

        .feedback-box {
            background-color: #eaf6ff;
            border: 1px solid #b3e0ff;
            border-radius: 10px;
            padding: 20px;
            font-size: 1.1em;
            line-height: 1.6;
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
            text-align: left;
        }
        .feedback-box p { margin: 0 0 10px 0; }
        .feedback-box strong { color: #0056b3; }

        /* Fishbone Tail Animations/States (using simple image changes) */
        /* ZEP í™˜ê²½ì—ì„œëŠ” ë™ì  SVGë‚˜ CSS ì• ë‹ˆë©”ì´ì…˜ì´ ë” ì¢‹ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ì´ë¯¸ì§€ ë³€ê²½ìœ¼ë¡œ ê°„ë‹¨í™” */
        .fishbone-diagram img.bone { content: url('/static/tail_bone.png'); width: 250px; } /* 0-10% */
        .fishbone-diagram img.basic_tail { content: url('/static/tail_basic.png'); width: 280px; } /* 11-40% */
        .fishbone-diagram img.normal_tail { content: url('/static/tail_normal.png'); width: 320px; } /* 41-70% */
        .fishbone-diagram img.colorful_tail { content: url('/static/tail_colorful.png'); width: 350px; } /* 71-90% */
        .fishbone-diagram img.gorgeous_tail { content: url('/static/tail_gorgeous.png'); width: 400px; } /* 91-100% */
        
        /* Animation for probability */
        @keyframes bounceIn {
            0% { transform: translateY(-50%) scale(0.5); opacity: 0; }
            50% { transform: translateY(-50%) scale(1.1); opacity: 1; }
            100% { transform: translateY(-50%) scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ job_title }} í•©ê²© ê°€ëŠ¥ì„± ë¶„ì„</h1>
        <p>ì„ íƒí•˜ì‹  ì§ë¬´ëŠ” <strong>{{ job_title }}</strong> ì…ë‹ˆë‹¤. ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ í•©ê²© ê°€ëŠ¥ì„±ì„ ë¶„ì„í•´ë³´ì„¸ìš”.</p>
        <p style="font-style: italic; color: #6c757d;">{{ job_details.description }}</p>

        <form id="analysisForm">
            <div class="input-group">
                <label for="resume_text">ğŸ“ ì´ë ¥ì„œ ë˜ëŠ” ìê¸°ì†Œê°œì„œ ë‚´ìš© ì§ì ‘ ì…ë ¥:</label>
                <textarea id="resume_text" name="resume_text" placeholder="ì´ë ¥ì„œ ë˜ëŠ” ìê¸°ì†Œê°œì„œì˜ ì£¼ìš” ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœëŒ€ 5000ì)"></textarea>
            </div>
            <div class="input-group">
                <label for="resume_file">â¬†ï¸ ë˜ëŠ” ì´ë ¥ì„œ íŒŒì¼ ì—…ë¡œë“œ (PDF, TXT, DOCX ë“±):</label>
                <input type="file" id="resume_file" name="resume_file" accept=".pdf,.txt,.docx">
            </div>

            <div class="input-group">
                <div class="section-title">ğŸ’¡ {{ job_title }} í•„ìˆ˜ ì—­ëŸ‰ ì²´í¬ (í•´ë‹¹í•˜ëŠ” ì—­ëŸ‰ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”):</div>
                <div class="checkbox-group">
                    {% for comp in job_details.competencies %}
                        <div>
                            <input type="checkbox" id="comp_{{ loop.index }}" name="selected_competencies" value="{{ comp }}">
                            <label for="comp_{{ loop.index }}">{{ comp }}</label>
                        </div>
                    {% endfor %}
                    {% if not job_details.competencies %}
                        <p>ì´ ì§ë¬´ì— ëŒ€í•œ ì—­ëŸ‰ ëª©ë¡ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                    {% endif %}
                </div>
            </div>

            <div class="input-group">
                <div class="section-title">ğŸ† {{ job_title }} ê´€ë ¨ ìê²©ì¦ ì„ íƒ (ë³´ìœ í•œ ìê²©ì¦ì„ ì„ íƒí•´ì£¼ì„¸ìš”):</div>
                <div class="checkbox-group">
                    {% for cert in job_details.certifications %}
                        <div>
                            <input type="checkbox" id="cert_{{ loop.index }}" name="selected_certifications" value="{{ cert }}">
                            <label for="cert_{{ loop.index }}">{{ cert }}</label>
                        </div>
                    {% endfor %}
                    {% if not job_details.certifications %}
                        <p>ì´ ì§ë¬´ì— ëŒ€í•œ ìê²©ì¦ ëª©ë¡ì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
                    {% endif %}
                </div>
                <label for="other_certifications" style="margin-top: 15px;">ê¸°íƒ€ ìê²©ì¦ ì§ì ‘ ì…ë ¥ (ì‰¼í‘œë¡œ êµ¬ë¶„):</label>
                <input type="text" id="other_certifications" name="other_certifications" placeholder="ì˜ˆ: SQLD, OCP, TOEIC">
            </div>

            <button type="submit" class="submit-button">âœ¨ í•©ê²© ê°€ëŠ¥ì„± ë¶„ì„í•˜ê¸° âœ¨</button>
            <div class="loading" id="loadingMessage">ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</div>
        </form>

        <div class="result-section" id="resultSection">
            <h2>ğŸ“Š ë¶„ì„ ê²°ê³¼: í•©ê²© ê°€ëŠ¥ì„±</h2>
            <div class="fishbone-diagram">
                <img id="fishboneTail" class="tail_bone" src="/static/tail_bone.png" alt="Fishbone Tail">
                <div class="fishbone-head">ì§ë¬´: {{ job_title }}</div>
                <div class="fishbone-prob" id="probabilityText">0%</div>
            </div>
            
            <div class="feedback-box">
                <div class="section-title">ğŸ’¡ AI í”¼ë“œë°±</div>
                <p id="feedbackContent"></p>
            </div>
            <p style="text-align: center; margin-top: 20px;"><a href="/" style="color: #007bff; text-decoration: none; font-weight: bold;">ë‹¤ë¥¸ ì§ë¬´ ë¶„ì„í•˜ëŸ¬ ê°€ê¸°</a></p>
        </div>
    </div>

    <script>
        document.getElementById('analysisForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // í¼ ì œì¶œ ê¸°ë³¸ ë™ì‘ ë°©ì§€

            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none'; // ì´ì „ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.getElementById('submitButton').disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™”

            const jobSlug = "{{ job_slug }}"; // Jinja2 í…œí”Œë¦¿ ë³€ìˆ˜ ì‚¬ìš©
            const formData = new FormData();
            
            formData.append('resume_text', document.getElementById('resume_text').value);
            const resumeFile = document.getElementById('resume_file').files[0];
            if (resumeFile) {
                formData.append('resume_file', resumeFile);
            }

            // ì„ íƒëœ ì—­ëŸ‰ ì²´í¬ë°•ìŠ¤ ê°’ ìˆ˜ì§‘
            const selectedCompetencies = Array.from(document.querySelectorAll('input[name="selected_competencies"]:checked')).map(cb => cb.value);
            selectedCompetencies.forEach(comp => formData.append('selected_competencies', comp));

            // ì„ íƒëœ ìê²©ì¦ ì²´í¬ë°•ìŠ¤ ê°’ ìˆ˜ì§‘
            const selectedCertifications = Array.from(document.querySelectorAll('input[name="selected_certifications"]:checked')).map(cb => cb.value);
            selectedCertifications.forEach(cert => formData.append('selected_certifications', cert));

            // ê¸°íƒ€ ìê²©ì¦ ì§ì ‘ ì…ë ¥ ê°’ ìˆ˜ì§‘
            const otherCertifications = document.getElementById('other_certifications').value.split(',').map(s => s.trim()).filter(s => s);
            otherCertifications.forEach(cert => formData.append('selected_certifications', cert)); // ê°™ì€ í•„ë“œëª…ìœ¼ë¡œ ì¶”ê°€

            try {
                const response = await fetch(`/api/analyze/${jobSlug}`, {
                    method: 'POST',
                    body: formData // FormData ê°ì²´ë¥¼ bodyì— ì§ì ‘ ë„£ìœ¼ë©´ Content-Typeì´ ìë™ìœ¼ë¡œ multipart/form-dataë¡œ ì„¤ì •ë¨
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('probabilityText').textContent = `${result.probability}%`;
                    document.getElementById('feedbackContent').textContent = result.feedback;
                    
                    const fishboneTail = document.getElementById('fishboneTail');
                    // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±° í›„ ìƒˆ í´ë˜ìŠ¤ ì¶”ê°€ (ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´)
                    fishboneTail.className = ''; 
                    fishboneTail.classList.add(result.tail_type);

                    document.getElementById('resultSection').style.display = 'block'; // ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
                } else {
                    alert(`ë¶„ì„ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }
            } catch (error) {
                console.error('Fetch error:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ í†µì‹  ì‹¤íŒ¨');
            } finally {
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('submitButton').disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            }
        });
    </script>
</body>
</html>